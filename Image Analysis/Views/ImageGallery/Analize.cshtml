@using System.Drawing
@using System.Drawing.Imaging
@using System.Text
@using Microsoft.AspNet.Identity
@using System.Net;
@model Image_Analysis.ViewModels.AnalizeViewModel

@{
    ViewBag.Title = "Analize";
}
<head>
    @*<script src="@Url.Content("~/Scripts/Images.js")"></script>*@
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src="/Scripts/jquery-1.10.2.js"></script>
    
</head>
   
<body>
 
<h2>Analize</h2>
<table>
    <tr>
        <td>
            <img src="data:image/png;base64,@Model.Image" height="400" width="600" id="filename"/>
            <button id="btn">Analyze</button>
        </td>
    </tr>
</table>
    <p id="response"></p>
<script type="text/javascript">
    var file = document.getElementById('filename');
    var imageJSON = {
        "image": {
            "imgLocation": file.src
        } 
    }
    var apiKey = "74106f204fd0492e9b7d93aba5b3e022";
    var apiUrl = "https://westus.api.cognitive.microsoft.com/emotion/v1.0/recognize?";

    $('#btn').click(function() {
        var file = document.getElementById('filename');
        CallAPI(imageJSON.image.imgLocation, apiUrl, apiKey);
    });
    makeblob = function (file) {
        var BASE64_MARKER = ';base64,';
        if (file.indexOf(BASE64_MARKER) == -1) {
            var parts = file.split(',');
            var contentType = parts[0].split(':')[1];
            var raw = decodeURIComponent(parts[1]);
            return new Blob([raw], { type: contentType });
        }
        var parts = file.split(BASE64_MARKER);
        var contentType = parts[0].split(':')[1];
        var raw = window.atob(parts[1]);
        var rawLength = raw.length;

        var uInt8Array = new Uint8Array(rawLength);

        for (var i = 0; i < rawLength; ++i) {
            uInt8Array[i] = raw.charCodeAt(i);
        }

        return new Blob([uInt8Array], { type: contentType });
    }

    function CallAPI(file, apiUrl, apiKey) {
        $.ajax({
                url: apiUrl,
                beforeSend: function(xhrObj) {
                    xhrObj.setRequestHeader("Content-Type", "application/octet-stream");
                    xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", apiKey);
                },
                type: "POST",
                processData: false,
                dataType: "json",
                data: makeblob(file)
            
            })
            .done(function(response) {
                console.log("success");
                processResult(response);
            })
            .fail(function() {
                console.log("error");
            });

        function processResult(response) {
            var data = JSON.stringify(response);
            $('#response').text(data);
        }
    };
</script>
</body>
